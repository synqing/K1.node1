{
  "name": "k1_pattern_compilation",
  "description": "Compile, test, and benchmark LED pattern code",
  "version": 1,
  "tasks": [
    {
      "name": "validate_pattern",
      "taskReferenceName": "validate_pattern_ref",
      "type": "SIMPLE",
      "inputParameters": {
        "patternName": "${workflow.input.patternName}",
        "patternCode": "${workflow.input.patternCode}"
      }
    },
    {
      "name": "generate_cpp",
      "taskReferenceName": "generate_cpp_ref",
      "type": "SIMPLE",
      "inputParameters": {
        "patternCode": "${validate_pattern_ref.output.validatedCode}",
        "targetDevice": "${workflow.input.targetDevice}"
      }
    },
    {
      "name": "compile_firmware",
      "taskReferenceName": "compile_firmware_ref",
      "type": "SIMPLE",
      "inputParameters": {
        "cppCode": "${generate_cpp_ref.output.generatedCode}",
        "optimizationLevel": "${workflow.input.optimizationLevel}"
      }
    },
    {
      "name": "run_tests",
      "taskReferenceName": "run_tests_ref",
      "type": "SIMPLE",
      "inputParameters": {
        "binaryPath": "${compile_firmware_ref.output.binaryPath}",
        "testSuites": ["unit", "integration"]
      }
    },
    {
      "name": "check_tests",
      "taskReferenceName": "check_tests_ref",
      "type": "SWITCH",
      "inputParameters": {
        "testsPassed": "${run_tests_ref.output.success}"
      },
      "evaluatorType": "javascript",
      "expression": "$.testsPassed ? \"true\" : \"false\"",
      "decisionCases": {
        "true": [
          {
            "name": "deploy_to_device",
            "taskReferenceName": "deploy_to_device_ref",
            "type": "SIMPLE",
            "inputParameters": {
              "binaryPath": "${compile_firmware_ref.output.binaryPath}",
              "deviceId": "test-device-001"
            }
          },
          {
            "name": "run_benchmarks",
            "taskReferenceName": "run_benchmarks_ref",
            "type": "SIMPLE",
            "inputParameters": {
              "deviceId": "test-device-001",
              "benchmarkType": "all"
            }
          },
          {
            "name": "check_benchmarks",
            "taskReferenceName": "check_benchmarks_ref",
            "type": "SWITCH",
            "inputParameters": {
              "fps": "${run_benchmarks_ref.output.fps}",
              "memoryUsageMb": "${run_benchmarks_ref.output.memoryUsageMb}"
            },
            "evaluatorType": "javascript",
            "expression": "$.fps >= 30 && $.memoryUsageMb < 100 ? \"PASS\" : \"FAIL\"",
            "decisionCases": {
              "PASS": [],
              "FAIL": [
                {
                  "name": "suggest_optimizations",
                  "taskReferenceName": "suggest_optimizations_ref",
                  "type": "SIMPLE",
                  "inputParameters": {
                    "benchmarks": "${run_benchmarks_ref.output}"
                  }
                }
              ]
            }
          }
        ],
        "false": [
          {
            "name": "analyze_test_failures",
            "taskReferenceName": "analyze_test_failures_ref",
            "type": "SIMPLE",
            "inputParameters": {
              "testResults": "${run_tests_ref.output}"
            }
          }
        ]
      }
    }
  ],
  "outputParameters": {
    "success": "${check_benchmarks_ref.output.status}",
    "binaryPath": "${compile_firmware_ref.output.binaryPath}",
    "testResults": "${run_tests_ref.output}",
    "benchmarks": "${run_benchmarks_ref.output}",
    "errors": "${analyze_test_failures_ref.output.errors}"
  },
  "schemaVersion": 2,
  "restartable": true,
  "timeoutPolicy": "ALERT_ONLY",
  "timeoutSeconds": 1800
}
