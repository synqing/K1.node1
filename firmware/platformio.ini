[platformio]
default_envs = esp32-s3-devkitc-1

[env:esp32-s3-devkitc-1]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino
platform_packages =
    platformio/framework-arduinoespressif32@3.20017.241212

; Serial/USB settings
upload_port = /dev/tty.usbmodem212401
monitor_speed = 2000000
upload_speed = 2000000
monitor_filters = esp32_exception_decoder

; Build settings
build_flags =
    -Os                           ; Optimize for size
    -DARDUINO_USB_CDC_ON_BOOT=1  ; Enable USB CDC
    -DCORE_DEBUG_LEVEL=1          ; Minimal debug output

; Libraries
lib_deps =
    ; OTA updates
    ArduinoOTA
    ; Async Web Server for REST API (pinned to v3.5.1 - stable, no breaking API changes)
    https://github.com/me-no-dev/ESPAsyncWebServer.git#23ae702d01c5144fc3764af5cdb9ca00470c3fc8
    ; Async TCP library (pinned to v3.3.2 - stable for ESP32-S3)
    https://github.com/me-no-dev/AsyncTCP.git#c3584edf815eec8101ddc23413164992e5220868
    ; JSON parsing for web API
    bblanchon/ArduinoJson@^6.21.4

; Partition table and filesystem
board_build.partitions = partitions.csv
board_build.filesystem = spiffs  ; Use SPIFFS for static file serving

; Unit Testing Configuration
test_framework = unity
test_speed = 2000000
test_port = /dev/tty.usbmodem212401
test_build_src = yes
test_ignore = test_hardware_stress  ; Exclude stress tests by default (run manually)

; Dedicated debug/telemetry environment
[env:esp32-s3-devkitc-1-debug]
extends = env:esp32-s3-devkitc-1
build_flags = 
    ${env:esp32-s3-devkitc-1.build_flags}
    -DDEBUG_TELEMETRY=1
    -DREALTIME_WS_ENABLED_DEFAULT=1
    -DREALTIME_WS_DEFAULT_INTERVAL_MS=250
    -DREST_AUDIO_ARRAYS=1
    -DSPECTROGRAM_HISTORY_FRAMES=16

; OTA upload environment (uses ArduinoOTA over Wiâ€‘Fi)
[env:esp32-s3-devkitc-1-ota]
extends = env:esp32-s3-devkitc-1
upload_protocol = espota
upload_port = 192.168.1.104

; Optional: hard-require IDF5 split RMT headers and dual-RMT v2 path
[env:esp32-s3-devkitc-1-rmtv2]
extends = env:esp32-s3-devkitc-1
build_flags =
    ${env:esp32-s3-devkitc-1.build_flags}
    -DREQUIRE_IDF5_DUAL_RMT=1

[env:esp32-s3-devkitc-1-rmtv2-ota]
extends = env:esp32-s3-devkitc-1-rmtv2
upload_protocol = espota
upload_port = 192.168.1.104

; Attempt an Arduino+ESP-IDF combo to expose split RMT headers explicitly
[env:esp32-s3-devkitc-1-idf5]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino, espidf
platform_packages =
    platformio/framework-arduinoespressif32@3.20017.241212
    platformio/framework-espidf@~3.50500.0
monitor_speed = 2000000
build_flags =
    -Os
    -DREQUIRE_IDF5_DUAL_RMT=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DCORE_DEBUG_LEVEL=1
board_build.partitions = partitions.csv
board_build.filesystem = spiffs
board_build.sdkconfig = sdkconfig.defaults

[env:esp32-s3-devkitc-1-idf5-ota]
extends = env:esp32-s3-devkitc-1-idf5
upload_protocol = espota
upload_port = 192.168.1.104
