; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = esp32-s3-devkitc-1
data_dir = data/ui

[common]
build_flags = 
	-Os
	-DARDUINO_USB_CDC_ON_BOOT=1
	-DCORE_DEBUG_LEVEL=1
	; Reduce AsyncTCP task stack to avoid xTaskCreate failures on S3 (default 16k uses scarce internal RAM)
	-D CONFIG_ASYNC_TCP_STACK_SIZE=6144
	; Basic warning flags
	-Wall
	-Wno-psabi
	; Link-Time Optimization for size reduction and dead code elimination
	-flto
	-ffat-lto-objects

[env:esp32-s3-devkitc-1]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino
platform_packages = 
	platformio/framework-arduinoespressif32@3.20017.241212
upload_port = /dev/tty.usbmodem2101
monitor_speed = 921600
upload_speed = 921600
monitor_filters = esp32_exception_decoder
build_flags = 
	${common.build_flags}
	; Enable core dump to flash for crash debugging
	-DCONFIG_ESP_COREDUMP_ENABLE_TO_FLASH=y
	-DCONFIG_ESP_COREDUMP_MAX_TASKS=64
	; Enable core dump on panic
	-DCONFIG_ESP_COREDUMP_CAPTURE_DRAM=y
	-DCONFIG_ESP_COREDUMP_CAPTURE_DRAM_SIZE=0x1000
; Exclude enhanced tempo detector (not yet integrated) and Phase 3 validation sources
build_src_filter =
    +<*>
    -<**/network/wifi_handlers.cpp>
    -<**/audio/tempo_validation_stubs.cpp>
; Enable DSP optimization script for performance-critical audio files
extra_scripts = optimize_dsp.py
lib_deps = 
	ArduinoOTA
	https://github.com/me-no-dev/ESPAsyncWebServer.git#23ae702d01c5144fc3764af5cdb9ca00470c3fc8
	https://github.com/me-no-dev/AsyncTCP.git#c3584edf815eec8101ddc23413164992e5220868
	bblanchon/ArduinoJson@^6.21.4
	fastled/FastLED@^3.10.3
; board_build.partitions = partitions_16mb.csv
board_build.filesystem = spiffs
data_dir = data/ui
test_framework = unity
test_speed = 921600
test_port = /dev/tty.usbmodem2101
test_build_src = yes
test_ignore = test_hardware_stress, test_stress_suite  ; Exclude long runs by default

[env:esp32-s3-devkitc-1-debug]
extends = env:esp32-s3-devkitc-1
build_flags = 
	${env:esp32-s3-devkitc-1.build_flags}
	-DDEBUG_TELEMETRY=1
	-DREALTIME_WS_ENABLED_DEFAULT=1
	-DREALTIME_WS_DEFAULT_INTERVAL_MS=250
	-DREST_AUDIO_ARRAYS=1
	-DSPECTROGRAM_HISTORY_FRAMES=16

lib_deps = fastled/FastLED@^3.10.3

[env:esp32-s3-devkitc-1-ota]
extends = env:esp32-s3-devkitc-1
upload_protocol = espota
upload_port = 192.168.1.105

; Metrics build for benchmarking (FRAME_METRICS_ENABLED=1)
[env:esp32-s3-devkitc-1-metrics]
extends = env:esp32-s3-devkitc-1
build_flags =
    ${env:esp32-s3-devkitc-1.build_flags}
    -DFRAME_METRICS_ENABLED=1

[env:esp32-s3-devkitc-1-metrics-ota]
extends = env:esp32-s3-devkitc-1-metrics
upload_protocol = espota
upload_port = 192.168.1.105

; Codegen PoC build: enable generated Bloom + Spectrum and metrics
[env:esp32-s3-devkitc-1-codegen]
extends = env:esp32-s3-devkitc-1-metrics
build_flags =
    ${env:esp32-s3-devkitc-1-metrics.build_flags}
    -DUSE_GENERATED_BLOOM_PATTERN
    -DUSE_GENERATED_SPECTRUM_PATTERN
    -DSPECTRUM_CENTER_OFFSET=-10
; Exclude baseline PoC sources to avoid duplicate symbol definitions
build_src_filter =
    +<*>
    -<**/pattern_bloom.cpp>
    -<**/pattern_spectrum.cpp>
    -<**/network/wifi_handlers.cpp>
    -<**/audio/tempo_validation_stubs.cpp>

[env:esp32-s3-devkitc-1-codegen-ota]
extends = env:esp32-s3-devkitc-1-codegen
upload_protocol = espota
upload_port = 192.168.1.105

[env:esp32-s3-devkitc-1-rmtv2]
extends = env:esp32-s3-devkitc-1
build_flags = 
	${env:esp32-s3-devkitc-1.build_flags}
	-DREQUIRE_IDF5_DUAL_RMT=1
lib_deps = fastled/FastLED@^3.10.3

[env:esp32-s3-devkitc-1-rmtv2-ota]
extends = env:esp32-s3-devkitc-1-rmtv2
upload_protocol = espota
upload_port = 192.168.1.104
lib_deps = fastled/FastLED@^3.10.3

[env:esp32-s3-devkitc-1-idf5]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino, espidf
platform_packages = 
	platformio/framework-arduinoespressif32@3.20017.241212
	platformio/framework-espidf@~3.50500.0
monitor_speed = 921600
build_flags = 
	-Os
	-DREQUIRE_IDF5_DUAL_RMT=1
	-DARDUINO_USB_CDC_ON_BOOT=1
	-DCORE_DEBUG_LEVEL=1
	; Enable core dump support
	-DCONFIG_ESP_COREDUMP_ENABLE_TO_FLASH=y
	-DCONFIG_ESP_COREDUMP_MAX_TASKS=64
board_build.partitions = partitions_8mb.csv
board_build.filesystem = spiffs
board_build.sdkconfig = sdkconfig.defaults
lib_deps = fastled/FastLED@^3.10.3

[env:esp32-s3-devkitc-1-idf5-ota]
extends = env:esp32-s3-devkitc-1-idf5
upload_protocol = espota
upload_port = 192.168.1.105
