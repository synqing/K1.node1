; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = esp32-s3-devkitc-1
data_dir = data/ui

[common]
build_flags = 
	-Os
	-DARDUINO_USB_CDC_ON_BOOT=1
	-DCORE_DEBUG_LEVEL=1
	; Reduce AsyncTCP task stack to avoid xTaskCreate failures on S3 (default 16k uses scarce internal RAM)
	-D CONFIG_ASYNC_TCP_STACK_SIZE=6144
	; Basic warning flags
	-Wall
	-Wno-psabi
	; Link-Time Optimization for size reduction and dead code elimination
	-flto
	-ffat-lto-objects

[env:esp32-s3-devkitc-1]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino
; Override default 8MB board definition for 4MB flash hardware
board_upload.flash_size = 4MB
board_build.flash_size = 4MB
platform_packages = 
	platformio/framework-arduinoespressif32@3.20017.241212
upload_port = /dev/tty.usbmodem2101
monitor_speed = 115200
upload_speed = 921600
monitor_filters = esp32_exception_decoder
build_flags = 
	${common.build_flags}
; Exclude enhanced tempo detector (not yet integrated) and Phase 3 validation sources
build_src_filter =
    +<*>
    -<**/network/wifi_handlers.cpp>
    -<**/audio/tempo_validation_stubs.cpp>
; Enable DSP optimization script for performance-critical audio files
extra_scripts = optimize_dsp.py
lib_deps = 
	ArduinoOTA
	https://github.com/me-no-dev/ESPAsyncWebServer.git#23ae702d01c5144fc3764af5cdb9ca00470c3fc8
	https://github.com/me-no-dev/AsyncTCP.git#c3584edf815eec8101ddc23413164992e5220868
	bblanchon/ArduinoJson@^6.21.4
	fastled/FastLED@^3.10.3
; Use 4MB partition layout to match hardware flash size
board_build.partitions = partitions.csv
board_build.filesystem = spiffs
test_framework = unity
test_speed = 921600
test_port = /dev/tty.usbmodem2101
test_build_src = yes
test_ignore = test_hardware_stress, test_stress_suite  ; Exclude long runs by default

[env:esp32-s3-devkitc-1-debug]
extends = env:esp32-s3-devkitc-1
build_flags = 
	${env:esp32-s3-devkitc-1.build_flags}
	-DDEBUG_TELEMETRY=1
	-DREALTIME_WS_ENABLED_DEFAULT=1
	-DREALTIME_WS_DEFAULT_INTERVAL_MS=250
	-DREST_AUDIO_ARRAYS=1
	-DSPECTROGRAM_HISTORY_FRAMES=16

lib_deps = fastled/FastLED@^3.10.3

[env:esp32-s3-devkitc-1-ota]
extends = env:esp32-s3-devkitc-1
upload_protocol = espota
upload_port = 192.168.1.105

; Metrics build for benchmarking (FRAME_METRICS_ENABLED=1)
