================================================================================
TEMPO DETECTION FAILURE - QUICK REFERENCE CARD
================================================================================

ROOT CAUSE
----------
File:      firmware/src/audio/goertzel.cpp
Lines:     574-575
Problem:   Tempo arrays memset to zero every frame (not synced)
Status:    DEFINITIVELY IDENTIFIED

THE BUG
-------
Current (BROKEN):
    memset(audio_back.tempo_magnitude, 0, sizeof(float) * NUM_TEMPI);
    memset(audio_back.tempo_phase, 0, sizeof(float) * NUM_TEMPI);

The Fix (4 lines):
    for (uint16_t i = 0; i < NUM_TEMPI; i++) {
        audio_back.tempo_magnitude[i] = tempi_smooth[i];
        audio_back.tempo_phase[i] = tempi[i].phase;
    }

WHY IT WORKS
------------
✓ tempi_smooth[i] calculated correctly (line 412 in tempo.cpp)
✓ tempi[i].phase calculated correctly (line 171 in tempo.cpp)
✓ Same pattern as working spectrum sync (line 563 in goertzel.cpp)
✓ Thread-safe (Core 1 writes, Core 0 reads snapshot copy)

IMPACT
------
Broken:     AUDIO_TEMPO_MAGNITUDE(bin) returns 0.0f (always)
Broken:     AUDIO_TEMPO_PHASE(bin) returns 0.0f (always)
Fixed:      Both macros return actual calculated values
Result:     17 tempo-reactive patterns start working

WHY 4 PREVIOUS ATTEMPTS FAILED
-------------------------------
Attempt 1:  Added validation layer (wrong layer - bug in sync, not calculation)
Attempt 2:  Tested Phase 3 revert (incomplete investigation)
Attempt 3:  Reverted Phase 3 (fixed wrong file - touched tempo.cpp not goertzel.cpp)
Attempt 4:  Restored pattern code (pattern code can't work without data)

Common mistake: All focused on tempo.cpp or pattern code. Bug is in goertzel.cpp.

VERIFICATION
-------------
Before Fix:
  Serial.printf("tempi_smooth[32] = %.3f\n", tempi_smooth[32]);
  → Should print non-zero (proves calculation works)

After Fix:
  PATTERN_AUDIO_START();
  float mag = AUDIO_TEMPO_MAGNITUDE(32);
  → Should equal tempi_smooth[32] value (proves sync works)

Visual Test:
  - Load Beat Tunnel pattern
  - Play 100+ BPM music
  - Before: Pattern frozen (gets zero data)
  - After: Pattern pulses to beat

IMPLEMENTATION
---------------
File:       firmware/src/audio/goertzel.cpp
Lines:      574-575 (replace these 2 lines)
New Size:   4 lines (net +2 lines)
Time:       5-10 minutes
Risk:       MINIMAL (proven pattern, no algorithm changes)
Revert:     Simple (git revert <commit>)

CONFIDENCE
----------
95%+ HIGH CONFIDENCE
- Root cause definitively identified with line-by-line evidence
- Solution follows proven pattern (spectrum sync identical)
- No alternative explanations fit evidence
- 4 previous attempts validate bug is in this location

COMMIT MESSAGE
--------------
fix(audio): Sync tempo magnitude and phase to AudioDataSnapshot

CRITICAL: Tempo detection data calculated but never exposed to patterns.
Lines 574-575 of goertzel.cpp memset tempo arrays to zero every frame,
preventing patterns from accessing beat magnitude and phase information.

This fix syncs calculated tempo data from Core 1 (audio task) to the
thread-safe snapshot used by Core 0 (rendering task):
- audio_back.tempo_magnitude[i] ← tempi_smooth[i]
- audio_back.tempo_phase[i] ← tempi[i].phase

Effect: Patterns can now access AUDIO_TEMPO_MAGNITUDE(bin) and
AUDIO_TEMPO_PHASE(bin) for beat-synchronized visuals.

EVIDENCE FILES
--------------
TEMPO_FORENSIC_ANALYSIS.md    - Complete 10-part technical analysis
TEMPO_FIX_REFERENCE.md        - Implementation guide with code examples
GIT_HISTORY_EVIDENCE.md       - Timeline of 4 failed attempts
TEMPO_EXECUTIVE_SUMMARY.md    - High-level summary
QUICK_REFERENCE.txt           - This file

DATA FLOW DIAGRAM
-----------------
Core 1 (Audio Task):
  tempo.cpp:229         tempi[i].magnitude = calculated_value ✓
  tempo.cpp:171         tempi[i].phase = atan2(...) ✓
  tempo.cpp:412         tempi_smooth[i] = exponential_average ✓

goertzel.cpp (PROBLEM):
  Line 574              audio_back.tempo_magnitude[i] = 0 ✗
  Line 575              audio_back.tempo_phase[i] = 0 ✗

Core 0 (Render Task):
  pattern_audio_interface.h:421  AUDIO_TEMPO_MAGNITUDE(bin) → 0.0f ✗
  pattern_audio_interface.h:453  AUDIO_TEMPO_PHASE(bin) → 0.0f ✗

FIX: Replace memset with loop (goertzel.cpp lines 574-575)
Result: Data flows from Core 1 → snapshot → Core 0 → patterns ✓

NEXT STEPS
----------
1. Review TEMPO_EXECUTIVE_SUMMARY.md
2. Review TEMPO_FIX_REFERENCE.md
3. Apply fix to goertzel.cpp:574-575
4. Compile and test
5. Commit with provided message
6. Deploy and verify pattern response to music

FINAL VERDICT
-------------
ROOT CAUSE:     Definitively identified (memset to zero in goertzel.cpp)
CONFIDENCE:     95%+ (high - irrefutable evidence)
FIX:            Trivial (4 lines, proven pattern)
TIME:           10 minutes total
EXPECTED RESULT: All 17 tempo-reactive patterns working

READY TO IMPLEMENT: YES

================================================================================
