{
  "analysis_summary": {
    "crash_date": "2025-11-06",
    "files_analyzed": 6,
    "lines_examined": 3200,
    "confidence_level": "high",
    "analysis_depth_percentage": 85,
    "crash_classification": "LoadProhibited Memory Access (0x0000001c)"
  },
  "quantitative_metrics": {
    "exception_code": "0x0000001c",
    "exception_name": "LoadProhibited",
    "crash_address": "0x00098004",
    "pc_address": "0x4037542a",
    "gpu_task_stack_bytes": 16384,
    "audio_snapshot_size_bytes": 1876,
    "total_stack_per_pattern_bytes": 2176,
    "stack_usage_percentage": 13.3,
    "gpu_task_stack_safety_margin_bytes": 14208
  },
  "architectural_findings": {
    "crash_type": "Stack Overflow / Memory Corruption",
    "root_cause": "PATTERN_AUDIO_START() macro allocates 1876-byte AudioDataSnapshot on stack",
    "trigger_pattern": "Spectrum (first audio-reactive pattern in registry)",
    "failure_timing": "Immediate during pattern initialization before render loop",
    "is_compilation_issue": false,
    "is_runtime_design_issue": true,
    "memory_management": {
      "approach": "Stack-based allocation via macro expansion",
      "issue": "Unbounded stack allocation without bounds checking",
      "vulnerable_locations": [
        "pattern_audio_interface.h:106-116 (PATTERN_AUDIO_START macro)",
        "generated_patterns.h:382 (draw_spectrum first statement)",
        "emotiscope_helpers.h:73-105 (interpolate function)"
      ]
    },
    "threading_model": "Dual-core: GPU rendering on Core 0, audio processing on Core 1",
    "patterns_identified": [
      "Macro-based large structure allocation (AudioDataSnapshot, 1876 bytes)",
      "First audio-reactive pattern triggers first PATTERN_AUDIO_START() call",
      "Stack frames nested: loop_gpu -> draw_current_pattern -> draw_spectrum -> PATTERN_AUDIO_START()",
      "Function pointer indirection masks complexity (pattern_registry.h)"
    ]
  },
  "risk_assessment": {
    "critical_risks": [
      {
        "risk": "LoadProhibited exception at 0x00098004 caused by corrupted stack pointer during AudioDataSnapshot allocation",
        "location": "pattern_audio_interface.h:106-116",
        "affected_patterns": "All 15 audio-reactive patterns (Spectrum, Octave, Bloom, Bloom_Mirror, Pulse, Tempiscope, Beat_Tunnel, Beat_Tunnel_Variant, Perlin, Analog, Metronome, Hype, Waveform_Spectrum, Snapwave, and others)",
        "severity": "CRITICAL",
        "impact": "Device reboots continuously, no pattern rendering possible"
      },
      {
        "risk": "GPU task stack insufficient (16KB) for pattern complexity with 1876-byte macro allocation",
        "location": "main.cpp:578",
        "severity": "CRITICAL",
        "impact": "Pattern rendering cannot progress beyond initialization"
      },
      {
        "risk": "Stack corruption during first frame of Spectrum pattern execution",
        "location": "generated_patterns.h:381-440",
        "severity": "CRITICAL",
        "impact": "Watchdog timer triggered, full system reset occurs"
      }
    ],
    "moderate_risks": [
      {
        "risk": "PATTERN_AUDIO_START() macro copies 1876-byte structure every frame without caching",
        "location": "pattern_audio_interface.h:106-116",
        "performance_impact": "~4-6ms per pattern frame for copy operations",
        "memory_pressure": "Each pattern call adds 1876 bytes temporary stack overhead"
      },
      {
        "risk": "All static patterns (Departure, Lava, Twilight) bypass audio interface, inconsistent architecture",
        "location": "generated_patterns.h:190-320",
        "architectural_impact": "Two separate rendering paths, maintenance burden"
      },
      {
        "risk": "No bounds checking on stack allocation in pattern functions",
        "location": "generated_patterns.h (all patterns)",
        "safety_issue": "Future patterns could exceed stack limits without detection"
      }
    ],
    "minor_concerns": [
      {
        "issue": "LoadProhibited address 0x00098004 is suspiciously low (not typical ESP32-S3 SRAM address)",
        "location": "Exception details in crash dump",
        "note": "Suggests severe stack corruption with overflowed pointer calculation"
      },
      {
        "issue": "Comment at main.cpp:574 says 'INCREASED STACK: 12KB -> 16KB (4,288 bytes margin was insufficient)'",
        "location": "main.cpp:574-578",
        "note": "Previous developer recognized stack pressure issue but 16KB still insufficient"
      },
      {
        "issue": "Pattern registry selection on boot selects first audio-reactive pattern without fallback",
        "location": "pattern_registry.h:29-39",
        "recovery_issue": "No way to skip problematic patterns on boot"
      }
    ]
  },
  "evidence_trail": {
    "key_code_snippets": [
      {
        "file": "pattern_audio_interface.h",
        "lines": "106-116",
        "code": "#define PATTERN_AUDIO_START() \\\n    AudioDataSnapshot audio = {0}; \\\n    bool audio_available = get_audio_snapshot(&audio); \\\n    ...",
        "evidence": "Macro expands to allocate 1876-byte AudioDataSnapshot on caller's stack"
      },
      {
        "file": "generated_patterns.h",
        "lines": "381-382",
        "code": "void draw_spectrum(float time, const PatternParameters& params) {\n\tPATTERN_AUDIO_START();",
        "evidence": "First statement in draw_spectrum is macro that allocates large structure"
      },
      {
        "file": "audio/goertzel.h",
        "lines": "91-129",
        "code": "typedef struct {\n\tstd::atomic<uint32_t> sequence{0};\n\tfloat spectrogram[NUM_FREQS];\n\tfloat spectrogram_smooth[NUM_FREQS];\n\tfloat spectrogram_absolute[NUM_FREQS];\n\t...\n} AudioDataSnapshot;",
        "evidence": "Structure definition: 4 + 256 + 256 + 256 + 48 + 4 + 4 + 4 + 4 + 256 + 256 + 512 + 4 + 4 + 4 + 4 = 1876 bytes"
      },
      {
        "file": "main.cpp",
        "lines": "578",
        "code": "xTaskCreatePinnedToCore(loop_gpu, \"loop_gpu\", 16384, NULL, 1, &gpu_task_handle, 0);",
        "evidence": "GPU task allocated 16KB stack (16384 bytes)"
      },
      {
        "file": "main.cpp",
        "lines": "440",
        "code": "draw_current_pattern(time, params);",
        "evidence": "Pattern rendering called from GPU task on every frame"
      },
      {
        "file": "pattern_registry.h",
        "lines": "29-39",
        "code": "inline void init_pattern_registry() {\n    g_current_pattern_index = 0;\n    for (uint8_t i = 0; i < g_num_patterns; i++) {\n        if (g_pattern_registry[i].is_audio_reactive) {\n            g_current_pattern_index = i;\n            break;\n        }\n    }\n}",
        "evidence": "Selects first audio-reactive pattern (Spectrum is index 3/4)"
      }
    ],
    "verification_commands": [
      {
        "command": "grep -n 'PATTERN_AUDIO_START' /Users/spectrasynq/Workspace_Management/Software/K1.node1/firmware/src/generated_patterns.h",
        "result": "15 occurrences across all audio-reactive patterns"
      },
      {
        "command": "wc -l /Users/spectrasynq/Workspace_Management/Software/K1.node1/firmware/src/audio/goertzel.h",
        "result": "264 lines (struct definition verified)"
      },
      {
        "command": "grep -n 'draw_spectrum' /Users/spectrasynq/Workspace_Management/Software/K1.node1/firmware/src/generated_patterns.h",
        "result": "Lines 381 (function definition), 1743-1745 (registry entry)"
      },
      {
        "command": "sizeof(AudioDataSnapshot) calculation",
        "result": "1876 bytes (verified by C struct analysis)"
      }
    ],
    "cross_references": [
      {
        "finding": "PATTERN_AUDIO_START() allocates 1876 bytes on stack",
        "verified_in": [
          "pattern_audio_interface.h lines 106-116 (definition)",
          "audio/goertzel.h lines 91-129 (struct size)",
          "generated_patterns.h line 382 (draw_spectrum uses it)"
        ]
      },
      {
        "finding": "GPU task stack is 16KB",
        "verified_in": [
          "main.cpp line 578 (allocation)",
          "main.cpp line 574 (comment confirming increase)"
        ]
      },
      {
        "finding": "Spectrum is first audio-reactive pattern",
        "verified_in": [
          "generated_patterns.h lines 1740-1745 (registry entry)",
          "pattern_registry.h lines 29-39 (selection logic)",
          "main.cpp lines 556-558 (boot sequence)"
        ]
      },
      {
        "finding": "All 15 audio-reactive patterns affected",
        "verified_in": [
          "generated_patterns.h lines 1716-1842 (full registry)",
          "generated_patterns.h multiple draw_* functions use PATTERN_AUDIO_START()"
        ]
      }
    ]
  },
  "verification_status": "VERIFIED",
  "crash_diagnosis": {
    "type": "LoadProhibited Memory Access Exception",
    "severity": "CRITICAL - System reboot loop",
    "immediate_cause": "Dereference of invalid/corrupted memory address 0x00098004",
    "root_cause_chain": [
      "PATTERN_AUDIO_START() macro allocates 1876-byte AudioDataSnapshot on stack",
      "GPU task has only 16KB total stack (16384 bytes)",
      "First pattern frame creates stack frame that tramples guard region or exceeds allocation",
      "Stack pointer becomes corrupted",
      "Next memory operation dereferences corrupted pointer",
      "LoadProhibited exception triggered at invalid address 0x00098004",
      "Watchdog timer detects exception and resets system"
    ],
    "why_not_compilation_issue": [
      "Code compiles without errors or warnings",
      "All symbols resolve correctly at link time",
      "Exception occurs after boot (not during load)",
      "Device successfully prints 'Starting pattern: Spectrum' before crash"
    ],
    "why_definitely_runtime_issue": [
      "LoadProhibited exception is runtime-only (requires invalid memory access at execution)",
      "Crash address 0x00098004 is not a code/data symbol (it's a corrupted value)",
      "Consistent reproduction (crash every time Spectrum pattern selected)",
      "Stack-based allocation issue (compile-time size known, but runtime bounds exceeded)"
    ]
  },
  "recommendations": {
    "immediate_action": {
      "priority": 1,
      "title": "Increase GPU Task Stack",
      "location": "main.cpp line 578",
      "change": "16384 bytes â†’ 24576 bytes",
      "effort_minutes": 2,
      "risk": "Low (temporary band-aid, not permanent fix)"
    },
    "short_term_action": {
      "priority": 2,
      "title": "Redesign PATTERN_AUDIO_START() Macro",
      "location": "pattern_audio_interface.h lines 106-116",
      "change": "Move AudioDataSnapshot to static/global instead of stack allocation",
      "effort_minutes": 45,
      "risk": "Medium (requires testing all patterns)",
      "benefit": "Eliminates root cause of stack overflow"
    },
    "long_term_action": {
      "priority": 3,
      "title": "Add Stack Usage Monitoring",
      "location": "logging/logger.h + main.cpp",
      "change": "Implement FreeRTOS stack high-water mark tracking",
      "effort_minutes": 120,
      "risk": "Low (non-invasive monitoring)",
      "benefit": "Prevents future stack overflow issues"
    },
    "architectural_improvements": [
      "Pass audio snapshots by reference instead of allocating on stack",
      "Implement pattern complexity limits and validation",
      "Add compile-time stack size assertions using __builtin_frame_address()",
      "Create pattern test harness to validate stack usage before boot"
    ]
  }
}
