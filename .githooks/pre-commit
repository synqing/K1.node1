#!/bin/bash

echo ""
echo "=========================================="
echo "K1.node1 File Naming Validation"
echo "=========================================="
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "✓ No files to validate"
    echo ""
    exit 0
fi

ERRORS=0

# Validate each file
for FILE in $STAGED_FILES; do
    FILENAME=$(basename "$FILE")
    DIR=$(dirname "$FILE")
    
    # Skip validation for files outside Conductor directory
    if [[ ! "$DIR" =~ ^Conductor ]]; then
        echo "✓ $FILE (outside Conductor, skipped)"
        continue
    fi
    
    # Skip validation for files in scripts/ directory (executables)
    if [[ "$DIR" =~ ^Conductor/scripts ]]; then
        echo "✓ $FILE (scripts directory, skipped)"
        continue
    fi
    
    # Exceptions: allow these files as-is
    case "$FILENAME" in
        .gitignore | conductor.json | README.md | CLAUDE.md | pre-commit)
            echo "✓ $FILE (exception)"
            continue
            ;;
    esac
    
    # Pattern: [ProjectCode]_[Type][_modifiers]_v[number].[number]_[YYYYMMDD].[ext]
    # Allow: K1N*, K1NCI*, K1NCond*, K1NTask* as project codes
    # Allow types with modifiers: GUIDE_HOOKS, ANNEX_A, etc
    # Require: v[number].[number] version
    # Require: _[YYYYMMDD] date
    
    if [[ "$FILENAME" =~ ^K1N[A-Za-z]*_[A-Z][A-Z0-9_]*_v[0-9]+\.[0-9]+_[0-9]{8}\.[a-z]+$ ]]; then
        echo "✓ $FILE"
    else
        echo "✗ INVALID: $FILENAME"
        echo "  Format: [ProjectCode]_[Type]_v[Version]_[YYYYMMDD].[ext]"
        echo "  Example: K1NCond_GUIDE_HOOKS_v1.0_20251108.md"
        ((ERRORS++))
    fi
done

echo ""
echo "=========================================="
if [ $ERRORS -eq 0 ]; then
    echo "✅ All Conductor files comply with naming standard"
else
    echo "❌ Naming issues found in Conductor/ (see above)"
fi
echo "=========================================="
echo ""

# --- Informational docs/ validator (non-blocking) ---
echo "Docs naming check (non-blocking)…"

BLOCK=${DOCS_NAMING_ENFORCE:-1}
DOC_ERRORS=0

while IFS= read -r FILE; do
  BASENAME=$(basename "$FILE")
  DIR=$(dirname "$FILE")
  # Skip exceptions
  if [[ "$FILE" =~ ^docs/archive/ ]]; then continue; fi
  if [[ "$FILE" =~ ^docs/02-adr/ADR-.*\.md$ ]]; then continue; fi
  if [[ "$BASENAME" == README.md ]]; then continue; fi
  if [[ "$FILE" == docs/_README_TEMPLATE.md ]]; then continue; fi
  # Preserve specialized nested docs per policy
  if [[ "$FILE" =~ ^docs/05-analysis/Conductor/ ]]; then continue; fi
  if [[ "$FILE" =~ ^docs/05-analysis/tab5/ ]]; then continue; fi
  if [[ "$FILE" =~ ^docs/03-guides/builderio ]]; then continue; fi
  # Accept K1N* prefixed files
  if [[ "$BASENAME" =~ ^K1N[A-Za-z]*_[A-Z0-9][A-Z0-9_]*_v[0-9]+\.[0-9]+_[0-9]{8}\.(md|txt|json)$ ]]; then
    continue
  fi
  echo "⚠ Non-compliant (docs/): $FILE"
  ((DOC_ERRORS++))
done < <(find docs -type f \( -name "*.md" -o -name "*.txt" -o -name "*.json" \))

if [ "$BLOCK" -eq 1 ] && [ $DOC_ERRORS -gt 0 ]; then
  echo ""
  echo "❌ COMMIT BLOCKED - $DOC_ERRORS docs/ file(s) violate K1N naming"
  echo "Set DOCS_NAMING_ENFORCE=0 to run non-blocking (default)"
  exit 1
fi

echo ""
echo "✅ Docs naming check completed (non-blocking). Issues: $DOC_ERRORS"
echo ""
exit 0
