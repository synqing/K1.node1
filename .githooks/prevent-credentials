#!/usr/bin/env bash
# Pre-commit hook to prevent credential commits
# Install: cp .githooks/prevent-credentials .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Color output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

FOUND_CREDENTIALS=0
FOUND_ENV=0

# Check for hardcoded WiFi SSID/Password patterns in staged files
echo "Checking for hardcoded credentials..."

# Patterns that indicate hardcoded credentials
CREDENTIAL_PATTERNS=(
    "SSID.*=.*['\"]"
    "PASSWORD.*=.*['\"]"
    "API_KEY.*=.*['\"]"
    "SECRET.*=.*['\"]"
    "TOKEN.*=.*['\"]"
    "parrs45432vw"  # Known test credential
    "OPTUS_738CC0"  # Known test SSID
)

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
    # Skip .env files (they should already be in .gitignore)
    if [[ "$file" == ".env"* ]]; then
        echo -e "${RED}ERROR:${NC} Attempting to commit ${file} - this file contains credentials!"
        FOUND_ENV=1
        continue
    fi

    # Skip .env.example (this is expected to be committed)
    if [[ "$file" == ".env.example" ]]; then
        continue
    fi

    # Check for credential patterns in code files
    if [[ "$file" =~ \.(cpp|h|c|hpp|py|js|ts|java)$ ]]; then
        for pattern in "${CREDENTIAL_PATTERNS[@]}"; do
            if git show :"$file" | grep -i -E "$pattern" > /dev/null 2>&1; then
                echo -e "${YELLOW}WARNING:${NC} Possible credential pattern in ${file}: ${pattern}"
                FOUND_CREDENTIALS=1
            fi
        done
    fi
done

# Exit with error if credentials found
if [ $FOUND_ENV -eq 1 ]; then
    echo ""
    echo -e "${RED}COMMIT REJECTED:${NC} .env files with credentials detected"
    echo "Use 'git add --force' to override (not recommended)"
    exit 1
fi

if [ $FOUND_CREDENTIALS -eq 1 ]; then
    echo ""
    echo -e "${RED}COMMIT WARNING:${NC} Possible credentials detected"
    echo "Review the warnings above. Use 'git commit --no-verify' to skip (not recommended)"
    exit 1
fi

echo -e "${GREEN}âœ“${NC} No credentials detected"
exit 0
