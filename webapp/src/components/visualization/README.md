# LED Visualization Components

A high-performance, real-time LED visualization system for the K1.reinvented project. This system provides WebSocket-based streaming of LED frame data with 120+ FPS rendering capabilities, interactive controls, and robust error handling.

## Features

- **Real-time WebSocket streaming** - Binary frame protocol with automatic reconnection
- **High-performance rendering** - Canvas2D with WebGL fallback, 120+ FPS capable
- **Interactive controls** - Zoom, pan, play/pause with keyboard shortcuts
- **Backpressure handling** - Adaptive frame queue with drop-oldest policy
- **Center-origin mirroring** - 180 LED positioning with symmetric layout
- **Mock data mode** - Development testing without hardware
- **TypeScript support** - Full type safety and IntelliSense

## Quick Start

### Basic Usage

```tsx
import { LedVisualization } from '@/components/visualization';

function MyComponent() {
  return (
    <LedVisualization
      config={{
        deviceEndpoint: 'ws://192.168.1.100:8080',
        autoConnect: true,
        showControls: true,
        showStats: true
      }}
      onConnectionChange={(connected) => {
        console.log('Connection:', connected ? 'Connected' : 'Disconnected');
      }}
      onError={(error) => {
        console.error('LED Visualization Error:', error);
      }}
    />
  );
}\n```\n\n### Simplified Embedded Version\n\n```tsx\nimport { LedVisualizationSimple } from '@/components/visualization';\n\nfunction EmbeddedLeds() {\n  return (\n    <LedVisualizationSimple \n      deviceEndpoint=\"192.168.1.100:8080\"\n      className=\"w-full h-64\"\n    />\n  );\n}\n```\n\n### Development with Mock Data\n\n```tsx\nimport { LedVisualizationMock } from '@/components/visualization';\n\nfunction DevelopmentPreview() {\n  return (\n    <LedVisualizationMock className=\"w-full h-96\" />\n  );\n}\n```\n\n### Using Configuration Presets\n\n```tsx\nimport { \n  LedVisualization, \n  LED_VISUALIZATION_PRESETS \n} from '@/components/visualization';\n\nfunction HighPerformanceVisualization() {\n  return (\n    <LedVisualization\n      config={{\n        ...LED_VISUALIZATION_PRESETS.highPerformance,\n        deviceEndpoint: 'ws://192.168.1.100:8080'\n      }}\n    />\n  );\n}\n```\n\n## Configuration\n\n### LedVisualizationConfig\n\n```typescript\ninterface LedVisualizationConfig {\n  // Connection settings\n  deviceEndpoint?: string;        // WebSocket endpoint\n  autoConnect?: boolean;          // Auto-connect on mount\n  reconnectAttempts?: number;     // Max reconnection attempts\n  \n  // Rendering settings\n  ledRadius?: number;             // LED circle radius in pixels\n  backgroundColor?: string;       // Canvas background color\n  targetFPS?: number;            // Target frame rate\n  enableWebGL?: boolean;         // Use WebGL renderer (future)\n  \n  // Position mapping\n  positionConfig?: PositionMappingConfig;\n  \n  // Frame queue settings\n  queueCapacity?: number;        // Frame buffer size\n  enableAdaptiveQueue?: boolean; // Adaptive capacity adjustment\n  \n  // UI settings\n  showControls?: boolean;        // Show interactive controls\n  showStats?: boolean;          // Show performance statistics\n  enableMockMode?: boolean;     // Use mock data instead of WebSocket\n}\n```\n\n### Position Mapping Configuration\n\n```typescript\ninterface PositionMappingConfig {\n  ledCount?: number;             // Number of LEDs (default: 180)\n  radius?: number;               // Circle radius\n  centerX?: number;              // Center X coordinate\n  centerY?: number;              // Center Y coordinate\n  angleOffset?: number;          // Starting angle in radians\n  clockwise?: boolean;           // LED arrangement direction\n  arcSpan?: number;             // Arc span in radians (2Ï€ for full circle)\n  spacing?: 'uniform' | 'custom'; // LED spacing mode\n  customSpacing?: number[];      // Custom angle positions\n}\n```\n\n## Advanced Usage\n\n### Custom WebSocket Subscription\n\n```tsx\nimport { \n  subscribeLedFrames, \n  buildLedFrameUrl,\n  type LedFrame \n} from '@/components/visualization';\n\nfunction CustomSubscription() {\n  useEffect(() => {\n    const subscription = subscribeLedFrames({\n      url: buildLedFrameUrl('http://192.168.1.100:8080'),\n      autoReconnect: true,\n      maxReconnectAttempts: 10\n    });\n    \n    subscription.on('frame', (frame: LedFrame) => {\n      console.log('Received frame:', frame.frameNumber);\n    });\n    \n    subscription.on('error', (error) => {\n      console.error('Subscription error:', error);\n    });\n    \n    subscription.start();\n    \n    return () => subscription.stop();\n  }, []);\n}\n```\n\n### Manual Renderer Control\n\n```tsx\nimport { \n  createLedRenderer,\n  computePositions,\n  createFrameQueue,\n  type ViewTransform\n} from '@/components/visualization';\n\nfunction ManualRenderer() {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const rendererRef = useRef<LedPreviewRenderer | null>(null);\n  \n  useEffect(() => {\n    if (!canvasRef.current) return;\n    \n    const positions = computePositions({ ledCount: 180 });\n    const frameQueue = createFrameQueue({ capacity: 3 });\n    \n    const renderer = createLedRenderer(\n      canvasRef.current,\n      positions,\n      () => frameQueue.popLatest(),\n      {\n        ledRadius: 3,\n        maxFPS: 60\n      }\n    );\n    \n    rendererRef.current = renderer;\n    renderer.start();\n    \n    return () => {\n      renderer.stop();\n    };\n  }, []);\n  \n  const handleTransform = (transform: Partial<ViewTransform>) => {\n    rendererRef.current?.setTransform(transform);\n  };\n  \n  return (\n    <canvas \n      ref={canvasRef} \n      className=\"w-full h-64\"\n    />\n  );\n}\n```\n\n### Position Mapping Examples\n\n```tsx\nimport { \n  computePositions,\n  createStandardConfigurations,\n  indexToPos,\n  indexMirror\n} from '@/components/visualization';\n\n// Full circle (default)\nconst circlePositions = computePositions();\n\n// Semi-circle\nconst semicirclePositions = computePositions({\n  arcSpan: Math.PI,\n  angleOffset: 0\n});\n\n// Custom arc\nconst arcPositions = computePositions({\n  arcSpan: Math.PI * 1.5,\n  angleOffset: Math.PI * 0.25\n});\n\n// Standard configurations\nconst configs = createStandardConfigurations();\nconst { circle, semicircle, arc, line } = configs;\n\n// Position utilities\nconst led0Position = indexToPos(0, circlePositions);\nconst led0Mirror = indexMirror(0); // Returns 179 for 180 LEDs\n```\n\n## Keyboard Shortcuts\n\nWhen the visualization has focus:\n\n- **Space** - Play/Pause\n- **+/-** - Zoom In/Out\n- **Ctrl+0** - Zoom to Fit\n- **Ctrl+R** - Reset View\n- **Drag** - Pan View\n- **Mouse Wheel** - Zoom at Cursor\n\n## Performance Optimization\n\n### Frame Queue Tuning\n\n```tsx\n// High-performance setup\nconst config = {\n  queueCapacity: 2,           // Minimal latency\n  enableAdaptiveQueue: true,  // Auto-adjust capacity\n  targetFPS: 120             // High frame rate\n};\n\n// Low-latency setup\nconst config = {\n  queueCapacity: 1,           // Single frame buffer\n  enableAdaptiveQueue: false, // Fixed capacity\n  targetFPS: 60              // Standard frame rate\n};\n```\n\n### Rendering Optimization\n\n```tsx\n// Optimized for performance\nconst config = {\n  ledRadius: 2,              // Smaller LEDs = faster rendering\n  enableWebGL: true,         // Use WebGL when available\n  backgroundColor: '#000000' // Solid color background\n};\n\n// Optimized for quality\nconst config = {\n  ledRadius: 4,              // Larger LEDs = better visibility\n  enableWebGL: false,        // Canvas2D for compatibility\n  backgroundColor: 'radial-gradient(circle, #0a0a0a 0%, #000000 100%)'\n};\n```\n\n## Error Handling\n\n```tsx\nimport { \n  LedVisualization,\n  ConnectionError,\n  RenderError\n} from '@/components/visualization';\n\nfunction ErrorHandlingExample() {\n  const handleError = (error: Error) => {\n    if (error instanceof ConnectionError) {\n      console.error('Connection failed:', error.endpoint);\n      // Show connection retry UI\n    } else if (error instanceof RenderError) {\n      console.error('Rendering failed:', error.context);\n      // Fallback to software rendering\n    } else {\n      console.error('Unknown error:', error.message);\n    }\n  };\n  \n  return (\n    <LedVisualization\n      config={{ deviceEndpoint: 'ws://192.168.1.100:8080' }}\n      onError={handleError}\n      onConnectionChange={(connected) => {\n        if (!connected) {\n          // Handle disconnection\n        }\n      }}\n    />\n  );\n}\n```\n\n## Testing\n\n### Mock Data Testing\n\n```tsx\nimport { LedVisualizationMock } from '@/components/visualization';\n\n// Use mock data for development\nfunction TestComponent() {\n  return (\n    <LedVisualizationMock className=\"w-full h-64\" />\n  );\n}\n```\n\n### Performance Benchmarking\n\n```tsx\nimport { \n  benchmarkFrameQueue,\n  benchmarkPositionMapping\n} from '@/components/visualization';\n\n// Benchmark frame queue performance\nconst queueBenchmark = benchmarkFrameQueue();\nconsole.log('Average push time:', queueBenchmark.averagePushTime, 'ms');\nconsole.log('Average pop time:', queueBenchmark.averagePopTime, 'ms');\n\n// Benchmark position mapping performance\nconst positionBenchmark = benchmarkPositionMapping();\nconsole.log('Position compute time:', positionBenchmark.computeTime, 'ms');\nconsole.log('Average indexToPos time:', positionBenchmark.averageIndexToPos, 'ms');\n```\n\n## Browser Compatibility\n\n- **Chrome/Edge**: Full support including WebGL\n- **Firefox**: Full support including WebGL\n- **Safari**: Canvas2D support, WebGL limited\n- **Mobile**: Canvas2D support, performance varies\n\n### Feature Detection\n\n```tsx\nimport { LED_VISUALIZATION_FEATURES } from '@/components/visualization';\n\nif (LED_VISUALIZATION_FEATURES.webgl) {\n  console.log('WebGL supported');\n}\n\nif (LED_VISUALIZATION_FEATURES.webSocket) {\n  console.log('WebSocket supported');\n}\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Connection Failed**\n   - Check device IP and port\n   - Verify WebSocket endpoint is accessible\n   - Check firewall settings\n\n2. **Poor Performance**\n   - Reduce `targetFPS`\n   - Decrease `ledRadius`\n   - Disable `showStats`\n   - Use `queueCapacity: 2`\n\n3. **Frame Drops**\n   - Enable `enableAdaptiveQueue`\n   - Increase `queueCapacity`\n   - Check network stability\n\n4. **Rendering Issues**\n   - Disable `enableWebGL`\n   - Check browser console for errors\n   - Verify canvas size is reasonable\n\n### Debug Mode\n\n```tsx\n// Enable debug logging\nconst config = {\n  showStats: true,\n  enableMockMode: true, // Use for testing without hardware\n};\n\n// Monitor performance\nconst handleStatsUpdate = (stats) => {\n  console.log('Render FPS:', stats.fps);\n  console.log('Queue size:', stats.queue.currentSize);\n  console.log('Dropped frames:', stats.queue.dropped);\n};\n```\n\n## API Reference\n\nSee the TypeScript definitions in the source files for complete API documentation:\n\n- `LedVisualization.tsx` - Main component\n- `ledFrameProtocol.ts` - WebSocket protocol\n- `frameQueue.ts` - Frame buffering\n- `ledRenderer.ts` - Canvas rendering\n- `ledPositionMapping.ts` - Position calculations\n- `LedVisualizationControls.tsx` - Interactive controls"